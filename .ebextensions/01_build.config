commands:
  01_system_packages:
    command: yum install -y gcc python3-devel postgresql-devel

  02_install_node:
    command: |
      set -euo pipefail
      if ! command -v node >/dev/null 2>&1; then
        curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
        yum install -y nodejs
      fi

  03_install_rsync:
    command: |
      set -euo pipefail
      yum install -y rsync

container_commands:
  01_install_client_deps:
    leader_only: true
    command: |
      set -euo pipefail
      # Install client deps (prefer reproducible installs when lockfile exists)
      if [ -f client/package-lock.json ]; then
        npm --prefix client ci --include=dev
      else
        npm --prefix client install --include=dev
      fi

  02_build_client:
    leader_only: true
    command: |
      set -euo pipefail
      npm --prefix client run build

  03_sync_build_into_server:
    leader_only: true
    command: |
      set -euo pipefail
      TARGET="server/src/metakb/build"
      mkdir -p "$TARGET"
      SRC="client/dist/"
      rsync -a --delete "$SRC" "$TARGET/"
